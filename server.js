require('dotenv').config();

const express = require('express');
const cors = require('cors');
const mongoose = require('mongoose');
const feedbackRouter = require('./routes/feedback');
const todosRouter = require('./routes/todos');
const authRouter = require('./routes/auth');

console.log('ğŸ”„ 1. Loading authMiddleware...');
const authMiddleware = require('./middleware/auth');
console.log('âœ… 2. AuthMiddleware loaded, type:', typeof authMiddleware);

const app = express();
const PORT = process.env.PORT || 5000;

app.use((req, res, next) => {
    console.log(`[${new Date().toISOString()}] ${req.method} ${req.url}`);
    next();
});

console.log('ğŸ”„ 3. Connecting to MongoDB...');
mongoose.connect(process.env.MONGO_URI)
    .then(() => console.log('MongoDB connected successfully'))
    .catch(err => {
        console.log('MongoDB connection error:', err.message);
        process.exit(1);
    });

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° CORS Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ°ĞºÑˆĞµĞ½Ğ° Ğ¸ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
const corsOptions = {
    origin: process.env.NODE_ENV === 'production'
        ? ['https://my-todo-list-g9k0rzu85-egorvot2007-3398s-projects.vercel.app']
        : ['http://localhost:3000', 'http://localhost:3001'],
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization']
};
app.use(cors(corsOptions));

// Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ğ¹ options handler - CORS middleware ÑĞ°Ğ¼ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ OPTIONS

app.use(express.static('public'));
app.use(express.urlencoded({ extended: true }));
app.use(express.json());

// ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµĞ¼ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ñ‹
console.log('ğŸ”„ 5. Setting up routes...');
app.use('/api', feedbackRouter);

console.log('ğŸ”„ 6. Applying authMiddleware to /api/v1/todos...');
app.use('/api/v1/todos', authMiddleware, todosRouter);
console.log('âœ… 7. AuthMiddleware applied to /api/v1/todos');

app.use('/api/auth', authRouter);
console.log('âœ… 8. All routes configured');

// Health check endpoint
app.get('/health', (req, res) => {
    res.status(200).json({
        status: 'OK',
        timestamp: new Date().toISOString(),
        environment: process.env.NODE_ENV || 'development'
    });
});

app.get('/', (req, res) => {
    res.json({
        message: 'ĞŸÑ€Ğ¸Ğ²ĞµÑ‚, Ğ¼Ğ¸Ñ€!',
        version: '1.0.0',
        environment: process.env.NODE_ENV || 'development'
    });
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ½ĞµÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ¼Ğ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¾Ğ² - Ğ˜Ğ¡ĞŸĞ ĞĞ’Ğ›Ğ•ĞĞ: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ *
app.use((req, res) => {
    res.status(404).json({ error: 'ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½' });
});

// Ğ“Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
app.use((err, req, res, next) => {
    console.error('âŒ Global error handler:', err);
    res.status(500).json({ error: 'Ğ’Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ€Ğ²ĞµÑ€Ğ°' });
});

app.listen(PORT, () => {
    console.log(`ğŸš€ 9. Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ ${PORT}`);
    console.log(`ğŸŒ Environment: ${process.env.NODE_ENV || 'development'}`);
});